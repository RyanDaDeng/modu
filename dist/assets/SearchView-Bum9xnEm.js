import{u as B,i as z,r as v,j as R,o as T,k as $,l as q,m as N,c as b,w as O,A as V,n as j,p as H,a as l,b as t,d as i,q as S,e as k,f as I,L as C,F,h as U}from"./index-DAKd_ngf.js";import{_ as Y}from"./ComicCard-DYvYCcpE.js";const D={class:"container mx-auto px-4 py-6"},J={key:0,class:"text-center py-12"},K={class:"max-w-md mx-auto"},Q={class:"space-y-3"},W={key:1,class:"text-center py-12"},G={key:2},X={key:0,class:"flex justify-center py-12"},Z={key:1,class:"text-center py-12"},ee={key:2,class:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-3"},te={key:3,class:"flex justify-center py-8"},se={key:4,class:"text-center py-8 text-gray-400"},oe={name:"SearchView"},ne=Object.assign(oe,{setup(re){const _=H(),m=$(),L=B(),g=z(),r=v(""),a=v([]),u=v(!1),c=v(1),n=v(!0),p=v(null);let d=null;const h="searchPageState",y="searchPageScroll",x=()=>{const s={searchQuery:r.value,comics:a.value,currentPage:c.value,hasMore:n.value,timestamp:Date.now()};sessionStorage.setItem(h,JSON.stringify(s))},M=()=>{const s=sessionStorage.getItem(h);if(s)try{const e=JSON.parse(s);if(e.searchQuery===r.value&&Date.now()-e.timestamp<1800*1e3)return a.value=e.comics||[],c.value=e.currentPage||1,n.value=e.hasMore!==void 0?e.hasMore:!0,setTimeout(()=>{const o=sessionStorage.getItem(y);o&&window.scrollTo(0,parseInt(o))},100),!0}catch(e){console.error("Failed to restore search state:",e)}return!1},w=async(s=!1)=>{if(!g.isLoggedIn){console.log("User not logged in, skipping search");return}if(!(!r.value||u.value&&!s)&&(s&&(a.value=[],c.value=1,n.value=!0,L.addSearchHistory(r.value),sessionStorage.removeItem(h),sessionStorage.removeItem(y)),!!n.value)){u.value=!0;try{const e=await j(r.value,c.value);console.log("Search API response:",e);const o=Array.isArray(e)?e:e?.content||[];if(!o||o.length===0)n.value=!1;else{const E=o.map(P=>({...P,page:c.value}));a.value.push(...E),c.value++,o.length<80&&(n.value=!1)}x()}catch(e){console.error("Search failed:",e),n.value=!1}finally{u.value=!1}}},A=()=>{d&&d.disconnect(),d=new IntersectionObserver(s=>{s[0].isIntersecting&&!u.value&&n.value&&r.value&&g.isLoggedIn&&w()},{rootMargin:"100px"}),p.value&&d.observe(p.value)},f=()=>{sessionStorage.setItem(y,window.scrollY.toString())};return R(()=>_.query.wd||_.query.q,s=>{console.log("Search query changed:",s,"Current:",r.value),s!==r.value&&(r.value=s||"",r.value&&g.isLoggedIn&&(M()||w(!0)))},{immediate:!0}),T(()=>{A(),window.addEventListener("beforeunload",f),m.beforeEach((s,e,o)=>{e.name==="search"&&a.value.length>0&&(f(),x()),o()})}),q(()=>{a.value.length>0&&(f(),x())}),N(()=>{d&&d.disconnect(),window.removeEventListener("beforeunload",f)}),(s,e)=>(l(),b(V,{title:r.value?`搜索结果: ${r.value}`:"搜索"},{default:O(()=>[t("div",D,[S(g).isLoggedIn?r.value?(l(),i("div",G,[u.value&&!a.value.length?(l(),i("div",X,[I(C)])):!a.value.length&&!u.value?(l(),i("div",Z,[...e[6]||(e[6]=[t("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),t("p",{class:"text-gray-400"},"没有找到相关结果",-1)])])):(l(),i("div",ee,[(l(!0),i(F,null,U(a.value,o=>(l(),b(Y,{key:`${o.id}-${o.page}`,comic:o},null,8,["comic"]))),128))])),u.value&&a.value.length?(l(),i("div",te,[I(C)])):k("",!0),!n.value&&a.value.length?(l(),i("div",se," 没有更多结果了 ")):k("",!0),t("div",{ref_key:"loadMoreTrigger",ref:p,class:"h-20"},null,512)])):(l(),i("div",W,[...e[5]||(e[5]=[t("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z","clip-rule":"evenodd"})],-1),t("p",{class:"text-gray-400"},"请输入搜索关键词",-1)])])):(l(),i("div",J,[t("div",K,[e[2]||(e[2]=t("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z","clip-rule":"evenodd"})],-1)),e[3]||(e[3]=t("h2",{class:"text-xl font-bold text-white mb-2"},"需要登录才能使用搜索",-1)),e[4]||(e[4]=t("p",{class:"text-gray-400 mb-6"},"登录后即可搜索海量漫画资源",-1)),t("div",Q,[t("button",{onClick:e[0]||(e[0]=o=>S(m).push("/login")),class:"w-full px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-medium hover:from-pink-600 hover:to-purple-700 transition-all transform hover:scale-105 cursor-pointer"}," 立即登录 "),t("button",{onClick:e[1]||(e[1]=o=>S(m).push("/register")),class:"w-full px-6 py-3 bg-gray-800/50 backdrop-blur-sm border border-gray-700 text-gray-300 rounded-xl font-medium hover:bg-gray-700/50 transition-all cursor-pointer"}," 注册新账号 ")])])]))])]),_:1},8,["title"]))}});export{ne as default};
