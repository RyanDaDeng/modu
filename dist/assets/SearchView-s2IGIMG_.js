import{u as P,r as d,i as L,o as B,j as R,k as T,l as z,c as _,w as N,A as O,m as V,n as j,a as o,b as n,d as c,e as x,f as w,L as k,F as q,h as $}from"./index-BbuldSzF.js";import{_ as F}from"./ComicCard-yMNccqax.js";const H={class:"container mx-auto px-4 py-6"},Y={key:0,class:"text-center py-12"},D={key:1},J={key:0,class:"flex justify-center py-12"},K={key:1,class:"text-center py-12"},U={key:2,class:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-3"},Q={key:3,class:"flex justify-center py-8"},W={key:4,class:"text-center py-8 text-gray-400"},G={name:"SearchView"},te=Object.assign(G,{setup(X){const y=j(),I=R(),M=P(),a=d(""),r=d([]),i=d(!1),u=d(1),l=d(!0),f=d(null);let v=null;const h="searchPageState",m="searchPageScroll",p=()=>{const t={searchQuery:a.value,comics:r.value,currentPage:u.value,hasMore:l.value,timestamp:Date.now()};sessionStorage.setItem(h,JSON.stringify(t))},b=()=>{const t=sessionStorage.getItem(h);if(t)try{const e=JSON.parse(t);if(e.searchQuery===a.value&&Date.now()-e.timestamp<1800*1e3)return r.value=e.comics||[],u.value=e.currentPage||1,l.value=e.hasMore!==void 0?e.hasMore:!0,setTimeout(()=>{const s=sessionStorage.getItem(m);s&&window.scrollTo(0,parseInt(s))},100),!0}catch(e){console.error("Failed to restore search state:",e)}return!1},S=async(t=!1)=>{if(!(!a.value||i.value&&!t)&&(t&&(r.value=[],u.value=1,l.value=!0,M.addSearchHistory(a.value),sessionStorage.removeItem(h),sessionStorage.removeItem(m)),!!l.value)){i.value=!0;try{const e=await V(a.value,u.value);console.log("Search API response:",e);const s=Array.isArray(e)?e:e?.content||[];if(!s||s.length===0)l.value=!1;else{const C=s.map(E=>({...E,page:u.value}));r.value.push(...C),u.value++,s.length<80&&(l.value=!1)}p()}catch(e){console.error("Search failed:",e),l.value=!1}finally{i.value=!1}}},A=()=>{v&&v.disconnect(),v=new IntersectionObserver(t=>{t[0].isIntersecting&&!i.value&&l.value&&a.value&&S()},{rootMargin:"100px"}),f.value&&v.observe(f.value)},g=()=>{sessionStorage.setItem(m,window.scrollY.toString())};return L(()=>y.query.wd||y.query.q,t=>{console.log("Search query changed:",t,"Current:",a.value),t!==a.value&&(a.value=t||"",a.value&&(b()||S(!0)))},{immediate:!0}),B(()=>{A(),window.addEventListener("beforeunload",g),I.beforeEach((t,e,s)=>{e.name==="search"&&r.value.length>0&&(g(),p()),s()})}),T(()=>{r.value.length>0&&(g(),p())}),z(()=>{v&&v.disconnect(),window.removeEventListener("beforeunload",g)}),(t,e)=>(o(),_(O,{title:a.value?`搜索结果: ${a.value}`:"搜索"},{default:N(()=>[n("div",H,[a.value?(o(),c("div",D,[i.value&&!r.value.length?(o(),c("div",J,[w(k)])):!r.value.length&&!i.value?(o(),c("div",K,[...e[1]||(e[1]=[n("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[n("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),n("p",{class:"text-gray-400"},"没有找到相关结果",-1)])])):(o(),c("div",U,[(o(!0),c(q,null,$(r.value,s=>(o(),_(F,{key:`${s.id}-${s.page}`,comic:s},null,8,["comic"]))),128))])),i.value&&r.value.length?(o(),c("div",Q,[w(k)])):x("",!0),!l.value&&r.value.length?(o(),c("div",W," 没有更多结果了 ")):x("",!0),n("div",{ref_key:"loadMoreTrigger",ref:f,class:"h-20"},null,512)])):(o(),c("div",Y,[...e[0]||(e[0]=[n("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[n("path",{"fill-rule":"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z","clip-rule":"evenodd"})],-1),n("p",{class:"text-gray-400"},"请输入搜索关键词",-1)])]))])]),_:1},8,["title"]))}});export{te as default};
