import{u as q,i as D,r as c,j as Y,o as J,k as K,l as W,m as G,c as M,w as Q,A as X,n as Z,p as ee,q as te,a,e as V,b as s,f as S,s as k,_ as oe,d as n,F as A,h as B,t as $,v as z,L as P,x as se}from"./index-CFF66pSp.js";import{_ as re}from"./ComicCard-BsNIPVVE.js";const ae={class:"container mx-auto px-4 py-6"},le={key:0,class:"text-center py-12"},ne={class:"max-w-md mx-auto"},ie={class:"space-y-3"},ue={key:1},ce={key:0,class:"space-y-6 max-w-5xl mx-auto"},de={class:"grid gap-6 md:grid-cols-2"},ve={class:"text-lg font-bold text-white mb-4 flex items-center"},ge={class:"flex flex-wrap gap-2"},pe=["onClick"],me={class:"relative"},he={key:1,class:"flex justify-center py-12"},fe={key:2,class:"text-center py-12"},ye={key:2},xe={key:0,class:"flex justify-center py-12"},be={key:1,class:"text-center py-12"},Se={key:2,class:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-3"},ke={key:3,class:"flex justify-center py-8"},we={key:4,class:"text-center py-8 text-gray-400"},_e={name:"SearchView"},Me=Object.assign(_e,{setup(Ie){const N=te(),f=K(),E=q(),d=D(),r=c(""),l=c([]),v=c(!1),u=c(1),i=c(!0),w=c(null),_=c(!1),y=c([]),I=c(!1);let g=null;const R=()=>{_.value=!0},j=t=>{r.value=t,l.value=[],u.value=1,i.value=!0,sessionStorage.removeItem(p),sessionStorage.removeItem(m),x(!0)},F=()=>{r.value="",l.value=[],i.value=!0,u.value=1,sessionStorage.removeItem(p),sessionStorage.removeItem(m),f.push("/search"),C()},C=async()=>{if(!(!d.isLoggedIn||y.value.length>0)){I.value=!0;try{const t=await Z();t&&t.blocks&&(y.value=t.blocks)}catch(t){console.error("Failed to load categories:",t)}finally{I.value=!1}}},H=t=>{console.log("Searching by tag:",t),r.value=t,l.value=[],u.value=1,i.value=!0,sessionStorage.removeItem(p),sessionStorage.removeItem(m),E.addSearchHistory(t),x(!0)},p="searchPageState",m="searchPageScroll",L=()=>{const t={searchQuery:r.value,comics:l.value,currentPage:u.value,hasMore:i.value,timestamp:Date.now()};sessionStorage.setItem(p,JSON.stringify(t))},O=()=>{const t=sessionStorage.getItem(p);if(t)try{const e=JSON.parse(t);if(e.searchQuery===r.value&&Date.now()-e.timestamp<1800*1e3)return l.value=e.comics||[],u.value=e.currentPage||1,i.value=e.hasMore!==void 0?e.hasMore:!0,setTimeout(()=>{const o=sessionStorage.getItem(m);o&&window.scrollTo(0,parseInt(o))},100),!0}catch(e){console.error("Failed to restore search state:",e)}return!1},x=async(t=!1)=>{if(!d.isLoggedIn){console.log("User not logged in, skipping search");return}if(!(!r.value||v.value&&!t)&&(t&&(l.value=[],u.value=1,i.value=!0,E.addSearchHistory(r.value),sessionStorage.removeItem(p),sessionStorage.removeItem(m)),!!i.value)){v.value=!0;try{const e=await ee(r.value,u.value);console.log("Search API response:",e);const o=Array.isArray(e)?e:e?.content||[];if(console.log("Parsed search results:",o),console.log("Number of results:",o.length),!o||o.length===0)i.value=!1;else{const h=o.map(T=>({...T,page:u.value}));l.value.push(...h),console.log("Comics array after update:",l.value),console.log("Total comics loaded:",l.value.length),u.value++,o.length<80&&(i.value=!1)}L()}catch(e){console.error("Search failed:",e),i.value=!1}finally{v.value=!1}}},U=()=>{g&&g.disconnect(),g=new IntersectionObserver(t=>{t[0].isIntersecting&&!v.value&&i.value&&r.value&&d.isLoggedIn&&x()},{rootMargin:"100px"}),w.value&&g.observe(w.value)},b=()=>{sessionStorage.setItem(m,window.scrollY.toString())};return Y(()=>N.query.wd,t=>{console.log("Search query changed:",t,"Current:",r.value),t!==void 0&&t!==r.value&&(r.value=t||"",r.value&&d.isLoggedIn?O()||x(!0):!r.value&&d.isLoggedIn&&C())},{immediate:!0}),J(()=>{U(),r.value||C(),window.addEventListener("beforeunload",b),f.beforeEach((t,e,o)=>{e.name==="search"&&l.value.length>0&&(b(),L()),o()})}),W(()=>{l.value.length>0&&(b(),L())}),G(()=>{g&&g.disconnect(),window.removeEventListener("beforeunload",b)}),(t,e)=>(a(),M(X,{title:r.value?`搜索结果: ${r.value}`:"搜索"},{default:Q(()=>[k(d).isLoggedIn?(a(),M(oe,{key:0,modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=o=>r.value=o),"show-current-query":!0,onClick:R,onClear:F},null,8,["modelValue"])):V("",!0),s("div",ae,[k(d).isLoggedIn?r.value?(a(),n("div",ye,[v.value&&!l.value.length?(a(),n("div",xe,[S(P)])):!l.value.length&&!v.value?(a(),n("div",be,[...e[11]||(e[11]=[s("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[s("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),s("p",{class:"text-gray-400"},"没有找到相关结果",-1)])])):(a(),n("div",Se,[(a(!0),n(A,null,B(l.value,o=>(a(),M(re,{key:`${o.id}-${o.page}`,comic:o},null,8,["comic"]))),128))])),v.value&&l.value.length?(a(),n("div",ke,[S(P)])):V("",!0),!i.value&&l.value.length?(a(),n("div",we," 没有更多结果了 ")):V("",!0),s("div",{ref_key:"loadMoreTrigger",ref:w,class:"h-20"},null,512)])):(a(),n("div",ue,[y.value.length>0?(a(),n("div",ce,[e[9]||(e[9]=s("div",{class:"text-center mb-8"},[s("h2",{class:"text-2xl sm:text-3xl font-bold text-white mb-3 bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent"},"热门标签"),s("p",{class:"text-gray-400"},"点击标签快速搜索相关漫画")],-1)),s("div",de,[(a(!0),n(A,null,B(y.value,o=>(a(),n("div",{key:o.title,class:"group bg-gradient-to-br from-gray-800/40 to-gray-900/40 backdrop-blur-sm rounded-2xl p-5 border border-white/10 hover:border-pink-500/30 transition-all duration-300"},[s("h3",ve,[e[7]||(e[7]=s("span",{class:"w-1.5 h-6 bg-gradient-to-b from-pink-500 to-purple-600 rounded-full mr-3 group-hover:h-7 transition-all"},null,-1)),$(" "+z(o.title),1)]),s("div",ge,[(a(!0),n(A,null,B(o.content,h=>(a(),n("button",{key:h,onClick:T=>H(h),class:"group/tag px-3 py-1.5 bg-gray-800/50 hover:bg-gradient-to-r hover:from-pink-500/30 hover:to-purple-600/30 border border-white/10 hover:border-pink-500/40 text-gray-300 hover:text-white rounded-lg text-sm transition-all duration-200 cursor-pointer hover:shadow-lg hover:shadow-pink-500/20 hover:scale-105 active:scale-95"},[s("span",me,[$(z(h)+" ",1),e[8]||(e[8]=s("span",{class:"absolute inset-0 rounded-lg bg-gradient-to-r from-pink-500 to-purple-600 opacity-0 group-hover/tag:opacity-20 blur transition-opacity"},null,-1))])],8,pe))),128))])]))),128))])])):I.value?(a(),n("div",he,[S(P)])):(a(),n("div",fe,[...e[10]||(e[10]=[s("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[s("path",{"fill-rule":"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z","clip-rule":"evenodd"})],-1),s("p",{class:"text-gray-400"},"请输入搜索关键词",-1)])]))])):(a(),n("div",le,[s("div",ne,[e[4]||(e[4]=s("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[s("path",{"fill-rule":"evenodd",d:"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z","clip-rule":"evenodd"})],-1)),e[5]||(e[5]=s("h2",{class:"text-xl font-bold text-white mb-2"},"需要登录才能使用搜索",-1)),e[6]||(e[6]=s("p",{class:"text-gray-400 mb-6"},"登录后即可搜索海量漫画资源",-1)),s("div",ie,[s("button",{onClick:e[1]||(e[1]=o=>k(f).push("/login")),class:"w-full px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-medium hover:from-pink-600 hover:to-purple-700 transition-all transform hover:scale-105 cursor-pointer"}," 立即登录 "),s("button",{onClick:e[2]||(e[2]=o=>k(f).push("/register")),class:"w-full px-6 py-3 bg-gray-800/50 backdrop-blur-sm border border-gray-700 text-gray-300 rounded-xl font-medium hover:bg-gray-700/50 transition-all cursor-pointer"}," 注册新账号 ")])])]))]),S(se,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=o=>_.value=o),onSearch:j},null,8,["modelValue"])]),_:1},8,["title"]))}});export{Me as default};
