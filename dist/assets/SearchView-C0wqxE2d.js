import{u as D,i as Y,r as c,j as J,o as K,k as Q,l as W,m as G,c as M,w as z,A as X,n as Z,p as ee,q as te,a,e as V,b as t,f as w,s as S,_ as oe,d as n,F as A,h as B,t as N,v as R,L as P,x as se}from"./index-BECairC3.js";import{_ as re}from"./ComicCard-DJ-8bugL.js";const ae={class:"container mx-auto px-4 py-6"},le={key:0,class:"text-center py-12"},ne={class:"max-w-md mx-auto"},ie={class:"space-y-3"},ue={key:1},ce={key:0,class:"space-y-6 max-w-5xl mx-auto"},de={class:"grid gap-6 md:grid-cols-2"},ve={class:"text-lg font-bold text-white mb-4 flex items-center"},ge={class:"flex flex-wrap gap-2"},pe=["onClick"],me={class:"relative"},he={key:1,class:"flex justify-center py-12"},fe={key:2,class:"text-center py-12"},ye={key:2},xe={key:0,class:"flex justify-center py-12"},be={key:1,class:"text-center py-12"},we={key:2,class:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 gap-3"},Se={key:3,class:"flex justify-center py-8"},ke={key:4,class:"text-center py-8 text-gray-400"},_e={name:"SearchView"},Me=Object.assign(_e,{setup(Ce){const j=te(),f=Q(),T=D(),v=Y(),r=c(""),l=c([]),d=c(!1),u=c(1),i=c(!0),k=c(null),_=c(!1),y=c([]),C=c(!1);let g=null;const E=()=>{_.value=!0},q=o=>{r.value=o,l.value=[],u.value=1,i.value=!0,sessionStorage.removeItem(p),sessionStorage.removeItem(m),x(!0)},F=()=>{r.value="",l.value=[],i.value=!0,u.value=1,sessionStorage.removeItem(p),sessionStorage.removeItem(m),f.push("/search"),I()},I=async()=>{if(!(!v.isLoggedIn||y.value.length>0)){C.value=!0;try{const o=await Z();o&&o.blocks&&(y.value=o.blocks)}catch(o){console.error("Failed to load categories:",o)}finally{C.value=!1}}},H=o=>{console.log("Searching by tag:",o),r.value=o,d.value=!0,window.scrollTo({top:0,behavior:"smooth"}),l.value=[],u.value=1,i.value=!0,sessionStorage.removeItem(p),sessionStorage.removeItem(m),T.addSearchHistory(o),x(!0)},p="searchPageState",m="searchPageScroll",L=()=>{const o={searchQuery:r.value,comics:l.value,currentPage:u.value,hasMore:i.value,timestamp:Date.now()};sessionStorage.setItem(p,JSON.stringify(o))},O=()=>{const o=sessionStorage.getItem(p);if(o)try{const e=JSON.parse(o);if(e.searchQuery===r.value&&Date.now()-e.timestamp<1800*1e3)return l.value=e.comics||[],u.value=e.currentPage||1,i.value=e.hasMore!==void 0?e.hasMore:!0,setTimeout(()=>{const s=sessionStorage.getItem(m);s&&window.scrollTo(0,parseInt(s))},100),!0}catch(e){console.error("Failed to restore search state:",e)}return!1},x=async(o=!1)=>{if(!v.isLoggedIn){console.log("User not logged in, skipping search");return}if(!(!r.value||d.value&&!o)&&(o&&(l.value=[],u.value=1,i.value=!0,T.addSearchHistory(r.value),sessionStorage.removeItem(p),sessionStorage.removeItem(m)),!!i.value)){d.value=!0;try{const e=await ee(r.value,u.value);console.log("Search API response:",e);const s=Array.isArray(e)?e:e?.content||[];if(console.log("Parsed search results:",s),console.log("Number of results:",s.length),!s||s.length===0)i.value=!1;else{const h=s.map($=>({...$,page:u.value}));l.value.push(...h),console.log("Comics array after update:",l.value),console.log("Total comics loaded:",l.value.length),u.value++,s.length<80&&(i.value=!1)}L()}catch(e){console.error("Search failed:",e),i.value=!1}finally{d.value=!1}}},U=()=>{g&&g.disconnect(),g=new IntersectionObserver(o=>{o[0].isIntersecting&&!d.value&&i.value&&r.value&&v.isLoggedIn&&x()},{rootMargin:"100px"}),k.value&&g.observe(k.value)},b=()=>{sessionStorage.setItem(m,window.scrollY.toString())};return J(()=>j.query.wd,o=>{console.log("Search query changed:",o,"Current:",r.value);const e=o||"";e!==r.value&&(r.value=e,r.value&&v.isLoggedIn?O()||x(!0):!r.value&&v.isLoggedIn&&I())},{immediate:!0}),K(()=>{U(),r.value||I(),window.addEventListener("beforeunload",b),f.beforeEach((o,e,s)=>{e.name==="search"&&l.value.length>0&&(b(),L()),s()})}),W(()=>{l.value.length>0&&(b(),L())}),G(()=>{g&&g.disconnect(),window.removeEventListener("beforeunload",b)}),(o,e)=>(a(),M(X,{title:r.value?`搜索结果: ${r.value}`:"搜索"},{action:z(()=>[t("button",{onClick:E,class:"lg:hidden p-2 text-gray-400 hover:text-pink-400 transition-colors",title:"搜索"},[...e[4]||(e[4]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)])])]),default:z(()=>[S(v).isLoggedIn?(a(),M(oe,{key:0,modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=s=>r.value=s),"show-bar":!0,"show-current-query":!0,onClick:E,onClear:F},null,8,["modelValue"])):V("",!0),t("div",ae,[S(v).isLoggedIn?r.value?(a(),n("div",ye,[d.value&&!l.value.length?(a(),n("div",xe,[w(P)])):!l.value.length&&!d.value?(a(),n("div",be,[...e[12]||(e[12]=[t("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z","clip-rule":"evenodd"})],-1),t("p",{class:"text-gray-400"},"没有找到相关结果",-1)])])):(a(),n("div",we,[(a(!0),n(A,null,B(l.value,s=>(a(),M(re,{key:`${s.id}-${s.page}`,comic:s},null,8,["comic"]))),128))])),d.value&&l.value.length?(a(),n("div",Se,[w(P)])):V("",!0),!i.value&&l.value.length?(a(),n("div",ke," 没有更多结果了 ")):V("",!0),t("div",{ref_key:"loadMoreTrigger",ref:k,class:"h-20"},null,512)])):(a(),n("div",ue,[y.value.length>0?(a(),n("div",ce,[e[10]||(e[10]=t("div",{class:"text-center mb-8"},[t("h2",{class:"text-2xl sm:text-3xl font-bold text-white mb-3 bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent"},"热门标签"),t("p",{class:"text-gray-400"},"点击标签快速搜索相关漫画")],-1)),t("div",de,[(a(!0),n(A,null,B(y.value,s=>(a(),n("div",{key:s.title,class:"group bg-gradient-to-br from-gray-800/40 to-gray-900/40 backdrop-blur-sm rounded-2xl p-5 border border-white/10 hover:border-pink-500/30 transition-all duration-300"},[t("h3",ve,[e[8]||(e[8]=t("span",{class:"w-1.5 h-6 bg-gradient-to-b from-pink-500 to-purple-600 rounded-full mr-3 group-hover:h-7 transition-all"},null,-1)),N(" "+R(s.title),1)]),t("div",ge,[(a(!0),n(A,null,B(s.content,h=>(a(),n("button",{key:h,onClick:$=>H(h),class:"group/tag px-3 py-1.5 bg-gray-800/50 hover:bg-gradient-to-r hover:from-pink-500/30 hover:to-purple-600/30 border border-white/10 hover:border-pink-500/40 text-gray-300 hover:text-white rounded-lg text-sm transition-all duration-200 cursor-pointer hover:shadow-lg hover:shadow-pink-500/20 hover:scale-105 active:scale-95"},[t("span",me,[N(R(h)+" ",1),e[9]||(e[9]=t("span",{class:"absolute inset-0 rounded-lg bg-gradient-to-r from-pink-500 to-purple-600 opacity-0 group-hover/tag:opacity-20 blur transition-opacity"},null,-1))])],8,pe))),128))])]))),128))])])):C.value?(a(),n("div",he,[w(P)])):(a(),n("div",fe,[...e[11]||(e[11]=[t("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z","clip-rule":"evenodd"})],-1),t("p",{class:"text-gray-400"},"请输入搜索关键词",-1)])]))])):(a(),n("div",le,[t("div",ne,[e[5]||(e[5]=t("svg",{class:"w-24 h-24 text-gray-600 mx-auto mb-4",fill:"currentColor",viewBox:"0 0 20 20"},[t("path",{"fill-rule":"evenodd",d:"M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z","clip-rule":"evenodd"})],-1)),e[6]||(e[6]=t("h2",{class:"text-xl font-bold text-white mb-2"},"需要登录才能使用搜索",-1)),e[7]||(e[7]=t("p",{class:"text-gray-400 mb-6"},"登录后即可搜索海量漫画资源",-1)),t("div",ie,[t("button",{onClick:e[1]||(e[1]=s=>S(f).push("/login")),class:"w-full px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-medium hover:from-pink-600 hover:to-purple-700 transition-all transform hover:scale-105 cursor-pointer"}," 立即登录 "),t("button",{onClick:e[2]||(e[2]=s=>S(f).push("/register")),class:"w-full px-6 py-3 bg-gray-800/50 backdrop-blur-sm border border-gray-700 text-gray-300 rounded-xl font-medium hover:bg-gray-700/50 transition-all cursor-pointer"}," 注册新账号 ")])])]))]),w(se,{modelValue:_.value,"onUpdate:modelValue":e[3]||(e[3]=s=>_.value=s),onSearch:q},null,8,["modelValue"])]),_:1},8,["title"]))}});export{Me as default};
